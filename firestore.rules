
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Allow public read access to the schemes collection for everyone.
    match /schemes/{schemeId} {
      allow read: if true;
      allow write: if request.auth != null; // Only admins should write, but for now allow any authenticated user.
    }

    // Allow users to read their own customer document after they have authenticated.
    // They cannot read other customer's documents.
    // This uses the phone number from their auth token to check against the document.
    match /customers/{customerId} {
       allow read, write: if request.auth != null && (
            request.auth.token.phone_number == resource.data.number ||
            request.auth.token.phone_number == '+91' + resource.data.number
       );
    }
    
    // Allow admins (any authenticated user for now) to list all customers.
    match /customers/{customerId} {
        allow list: if request.auth != null;
    }
  }
}
