rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Allow public read for schemes
    match /schemes/{schemeId} {
      allow read: if true;
      allow write: if request.auth != null; // Admins are any authenticated user
    }

    // Customer collection rules
    match /customers/{customerId} {
      // Allow a user to read their own document if they are logged in.
      // This rule is essential for the customer dashboard page to function after login.
      allow get: if request.auth != null && request.auth.token.phone_number == resource.data.number;
      
      // Allow admins to perform any write operation.
      allow write: if request.auth != null;
    }

    // This rule allows the initial query during the login process.
    // It lets a user query the collection to find their own document.
    match /customers/{document=**} {
        allow list: if request.auth != null && request.query.limit <= 1 && 
                       (request.query.where.size() == 1 || request.query.where.size() == 2) &&
                       ('number' in request.query.where);
    }
  }
}
